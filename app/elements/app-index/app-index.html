<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="app-index">
  <style is="custom-style">

    /*
     Polymer includes a shim for CSS Custom Properties that we can use for application theming.
     Below, you'll find the default palette for the Polymer Starter Kit layout. Feel free to play
     with changing the colors used or generate your own palette of colours at MaterialPalette.com.

     See https://www.polymer-project.org/1.0/docs/devguide/styling.html#xscope-styling-details
     for further information on custom CSS properties.
     */

    /* General styles */
    #drawerToolbar {
      color: var(--secondary-text-color);
      background-color: var(--drawer-menu-color);
      border-bottom: var(--drawer-toolbar-border-color);
    }
    .searchBar{background-color: var(--secondary-text-color);}
    .searchBar input{color: var(--text-primary-color);}

    paper-material{ width: calc(98.66% - 16px);}
    .paper-menu > .iron-selected {  color: var(--default-primary-color);  }
    paper-menu a{  color: var(--menu-link-color);  }

    @media (max-width:600px){paper-material{width: calc(97.33% - 32px);}  }

  </style>
  <link rel="stylesheet" href="app-index.css">
  <template>
    <paper-drawer-panel id="paperDrawerPanel">
      <!-- Drawer Scroll Header Panel -->
      <paper-scroll-header-panel drawer fixed>

        <!-- Drawer Toolbar -->
        <paper-toolbar id="drawerToolbar">
          <span class="paper-font-title">User Name</span>
        </paper-toolbar>

        <!-- Drawer Content -->

        <paper-menu class="list" attr-for-selected="data-route" selected="[[route]]">
          <template  is="dom-repeat" items="{{menuItems}}">
            <a data-route$="{{item.activity}}" href$="{{item.href}}" on-click="onDataRouteClick">
              <iron-icon icon$="{{item.icon}}"></iron-icon>
              <span>{{item.name}}</span>
            </a>
          </template>
        </paper-menu>

      </paper-scroll-header-panel>

      <!-- Main Area -->
      <paper-scroll-header-panel on-content-scroll="_onContentScroll"  on-paper-header-transform="_onHeaderTransform" main condenses keep-condensed-header>

        <!-- Main Toolbar -->
        <paper-toolbar id="mainToolbar" class="tall">

          <paper-icon-button id="paperToggle" icon="menu" paper-drawer-toggle></paper-icon-button>
          <div class="flex">
            <template is="dom-if" if="{{searchVisible}}">
              <div class=" searchBar horizontal layout">
                <div class="flex">
                  <input  is="iron-input" bind-value="{{searchValue}}">
                </div>
                <paper-icon-button icon="clear"  on-click="_clearSearch"></paper-icon-button>
              </div>
            </template>
          </div>

          <!-- Toolbar icons -->

          <template is="dom-if" if="{{!searchVisible}}">
            <paper-icon-button icon="search"  on-click="_toggleSearch"></paper-icon-button>
            <paper-icon-button icon="refresh" on-click="_sendRefresh"></paper-icon-button>
          </template>

          <!-- Application name -->
          <div class="middle middle-container center horizontal layout">
            <div class="app-name">Graphene toolbox alpha</div>
          </div>

          <!-- Application sub title -->
          <div class="bottom bottom-container center horizontal layout">
            <div class="bottom-title paper-font-subhead">Smartest solution for graphene management </div>
          </div>

        </paper-toolbar>

        <!-- Main Content -->
        <div class="content">
            <iron-pages id="activities" attr-for-selected="data-route"  selected="{{route}}">
              <!-- activities -->
            </iron-pages>
        </div>
      </paper-scroll-header-panel>
    </paper-drawer-panel>
  </template>

  <script src="menuSettings.js"></script>
  <script>
  (function(document) {
    'use strict'
    Polymer({
      is: 'app-index',
      attached : function(){
        //this.menuItems = document.menuSettings;
        document.addEventListener("sys-activity-init", function(e){ this._onActivityInit(e)          }.bind(this), false);

      },
      _sendRefresh:function(){
        this.currentActivity.onRefresh();
      },

      _toggleSearch:function(){
        if(!this.searchVisible)this.scrollPageToTop();
        this.searchVisible=!this.searchVisible;
      },

      _clearSearch:function(){
        this.searchValue='';
        this.searchVisible=false;
      },

      _onActivityInit:function(e){
        if(this.initActivity == null)this.initActivity=[];
        if(
          this.activities.indexOf(e.detail.activity) !== -1 &&
          this.initActivity.indexOf(e.detail.activity) === -1

        ){
          this.initActivity.push(e.detail.activity);

        }

        if(this.initActivity.length >= this.activities.length){
          this._fireActivityLoaded()
        }
      },
      _onContentScroll:function(e){
        var event = new CustomEvent("indexContentScroll", {detail: e.detail,bubbles: true,cancelable: true});
        document.dispatchEvent(event);
      },

      _onHeaderTransform:function(e){
        var appName = document.querySelector('#mainToolbar .app-name');
        var middleContainer = document.querySelector('#mainToolbar .middle-container');
        var bottomContainer = document.querySelector('#mainToolbar .bottom-container');
        var detail = e.detail;
        var heightDiff = detail.height - detail.condensedHeight;
        var yRatio = Math.min(1, detail.y / heightDiff);
        var maxMiddleScale = 0.50;  // appName max size when condensed. The smaller the number the smaller the condensed size.
        var scaleMiddle = Math.max(maxMiddleScale, (heightDiff - detail.y) / (heightDiff / (1-maxMiddleScale))  + maxMiddleScale);
        var scaleBottom = 1 - yRatio;
        Polymer.Base.transform('translate3d(0,' + yRatio * 100 + '%,0)', middleContainer);
        Polymer.Base.transform('scale(' + scaleBottom + ') translateZ(0)', bottomContainer);
        Polymer.Base.transform('scale(' + scaleMiddle + ') translateZ(0)', appName);
        if(detail.y > 20){
          this.searchVisible=false;
        }
      },

      displayInstalledToast : function() {
        // Check to make sure caching is actually enabledâ€”it won't be in the dev environment.
        if (!document.querySelector('platinum-sw-cache').disabled) {
          document.querySelector('#caching-complete').show();
        }
      },

      onDataRouteClick : function() {
        var drawerPanel = document.querySelector('#paperDrawerPanel');
        if (drawerPanel.narrow) {
          drawerPanel.closeDrawer();
        }
      },

      // Scroll page to top and expand header
      scrollPageToTop : function() {
        try{document.getElementById('mainContainer').scrollTop = 0;}catch(e){}
      },

      _fireActivityLoaded:function(){
        var event = new CustomEvent("sys-app-index-activity-loaded", {
          detail:{},
          bubbles: true,cancelable: true});
        document.dispatchEvent(event);
      },

      _onActivityList:function(newV,oldV){
        for(var i in newV){
          var elem = document.createElement(newV[i]);
          Polymer.dom(this.$.activities).appendChild(elem);
        }
        console.log(this.activities);
      },

      setRoute:function(route, params){
        //Stop old activity
        var oldActivity = this.$$('#activities > '+this.route);
        var newActivity = this.$$('#activities > '+route);
        this.currentActivity=newActivity;
        //se la nuova activity esiste, ma la vecchia no
        if(!(!!oldActivity) && !!newActivity){
          this._clearSearch();
          newActivity.onStart();
          newActivity._setPars(params);

        }else if(!(!!newActivity) && !!oldActivity){   //se la vecchia activity esiste, ma la nuova no
          oldActivity.onStop();
        }else if(
          !!oldActivity && !!newActivity &&
          (oldActivity.activityId !== newActivity.activityId)
        ){ //se esistono entrambe, ma sono diverse tra loro
          this._clearSearch();
          oldActivity.onStop();
          newActivity.onStart();
          newActivity._setPars(params);
        }else if(
          !!oldActivity && !!newActivity &&
          (oldActivity.activityId === newActivity.activityId)
        ){//se esistono entrambe, e sono uguali tra loro
          newActivity._setPars(params);
        }

        this.route  = route;
        this.params = params;

      },

      _onSearchValueChange:function(n){
        clearTimeout(this._lastSearch);
        this._lastSearch = setTimeout(
          function(){
              this.currentActivity.onSearch(n);
          }.bind(this),600);
      },

      properties:{
        route           : {type:String },
        params          : {type:Object},
        searchValue     : {type:String, observer:'_onSearchValueChange'},
        activities      : {type:Array,  observer :'_onActivityList'},
        searchVisible   : {type:Boolean, value:false},
        currentActivity : Object,
        menuItems       : Array,
        initActivity    : Array,
        _lastSearch     : Object
      }
    });
  })(document);
  </script>
</dom-module>
