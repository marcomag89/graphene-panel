<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<!--

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../graphene-client/graphene-client.html">
<link rel="import" href="../graphene-doc/graphene-doc.html">
<link rel="import" href="../../conf/api-settings.html">
-->
<dom-module id="graphene-crud">
  <template>
    <graphene-client id="client"></graphene-client>
    <graphene-doc id="create-doc"></graphene-doc>
    <graphene-doc id="read-doc"></graphene-doc>
    <graphene-doc id="update-doc"></graphene-doc>
    <graphene-doc id="delete-doc"></graphene-doc>
  </template>
  <script>
    JSON.flatten = function (data) {
      var result = {};

      function recurse(cur, prop) {
        if (Object(cur) !== cur) {
          result[prop] = cur;
        } else if (Array.isArray(cur)) {
          for (var i = 0, l = cur.length; i < l; i++)
            recurse(cur[i], prop + "[" + i + "]");
          if (l == 0)
            result[prop] = [];
        } else {
          var isEmpty = true;
          for (var p in cur) {
            isEmpty = false;
            recurse(cur[p], prop ? prop + "." + p : p);
          }
          if (isEmpty && prop)
            result[prop] = {};
        }
      }

      recurse(data, "");
      return result;
    }

    JSON.unflatten = function (data) {
      "use strict";
      if (Object(data) !== data || Array.isArray(data))
        return data;
      var regex = /\.?([^.\[\]]+)|\[(\d+)\]/g,
        resultholder = {};
      for (var p in data) {
        var cur = resultholder,
          prop = "",
          m;
        while (m = regex.exec(p)) {
          cur = cur[prop] || (cur[prop] = (m[2] ? [] : {}));
          prop = m[2] || m[1];
        }
        cur[prop] = data[p];
      }
      return resultholder[""] || resultholder;
    };
  </script>
  <script>
    (function () {
      'use strict';
      Polymer({
        is: 'graphene-crud',
        attached: function () {
          this._cODoc = this.$$('#create-doc');
          this._rODoc = this.$$('#read-doc');
          this._uODoc = this.$$('#update-doc');
          this._dODoc = this.$$('#delete-doc');

          //Creating listeners
          this._cODoc.addEventListener('doc-update', function (e) {
            this._onCreateDoc(e)
          }.bind(this));
          this._rODoc.addEventListener('doc-update', function (e) {
            this._onReadDoc(e)
          }.bind(this));
          this._uODoc.addEventListener('doc-update', function (e) {
            this._onUpdateDoc(e)
          }.bind(this));
          this._dODoc.addEventListener('doc-update', function (e) {
            this._onDeleteDoc(e)
          }.bind(this));
        },

        _onCreateDoc: function (e) {
          console.log(e.detail[0]);
          this._cDoc = e.detail[0];
          this.checkReady();
        },
        _onReadDoc: function (e) {
          console.log(e.detail[0]);
          this._rDoc = e.detail[0];
          this.checkReady();
        },
        _onUpdateDoc: function (e) {
          console.log(e.detail[0]);
          this._uDoc = e.detail[0];
          this.checkReady();
        },
        _onDeleteDoc: function (e) {
          console.log(e.detail[0]);
          this._dDoc = e.detail[0];
          this.checkReady();
        },

        checkReady: function () {
          if (!!this._cDoc && !!this._rDoc && !!this._uDoc && !!this._dDoc) {
            this.fire('crud-ready');
            return true;
          }
          return false;
        },

        create: function (model) {
          return this.$.client.fetch(this._cDoc.url, model);
        },

        read: function (id) {
          return this.$.client.fetch(this._rDoc.url.replace(':id', id));
        },

        update: function (model) {
          return this.$.client.fetch(this._uDoc.url, model, this._uDoc.method);
        },

        delete: function (model) {
          return this.$.client.fetch(this._dDoc.url, model);
        },
        getCStruct: function () {
          return this._cDoc.interface['flat-struct'];
        },
        getRStruct: function () {
          return this._rDoc.interface['flat-struct'];
        },
        getUStruct: function () {
          return this._uDoc.interface['flat-struct'];
        },
        getDStruct: function () {
          return this._dDoc.interface['flat-struct'];
        },

        flatToTree: function (flatModel) {

        },
        isValid: function (model, mode) {
          return true;
        },

        _modelNameChanged: function (newModelName) {
          this.modelName = newModelName;
          if (!!apiSettings.actions[this.modelName]) {
            this._cODoc.setActionName(apiSettings.actions[this.modelName].c);
            this._rODoc.setActionName(apiSettings.actions[this.modelName].r);
            this._uODoc.setActionName(apiSettings.actions[this.modelName].u);
            this._dODoc.setActionName(apiSettings.actions[this.modelName].d);
          } else {
            console.error('crud for ' + this.modelName + ' is not handled check the api-settings.html file');
          }
        },

        getModelPrototype: function () {
          var dots = {};
          var flat = this._cDoc.interface['flat-struct'];
          for (var i in flat) {
            dots[i.replace(new RegExp('_', 'g'), '.')] = '';
          }
          console.log(dots);
          console.log(JSON.unflatten(dots));
          return JSON.parse(JSON.stringify(JSON.unflatten(dots)));
        },

        properties: {
          modelName: {type: String, observer: '_modelNameChanged'}, //namespace-modelname
          _cODoc: Object,
          _rODoc: Object,
          _uODoc: Object,
          _dODoc: Object,

          _cDoc: Object,
          _rDoc: Object,
          _uDoc: Object,
          _dDoc: Object,

          //Modello corrente
          model: Object
        }
      });
    })();
  </script>
</dom-module>
