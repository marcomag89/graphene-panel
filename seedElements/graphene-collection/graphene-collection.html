<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="collection-fetcher-tools.html">
<link rel="import" href="collection-fetcher-behavior.html">
<dom-module id="graphene-collection">
  <template>
    <graphene-client role = "client" ></graphene-client>
    <graphene-doc    role = "doc"  on-doc-update= "_onDocUpdate"></graphene-doc>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'graphene-collection',
      behaviors:[collectionFetcherBehavior],

      attached:function(){
        this._elements={};
        this._elements.doc = this.$$('[role = doc]');
      },

      _onDocUpdate:function(e){
        this._reqUrl = e.detail[0].url;
        this.refresh();
      },

      getElementStruct:function(){
        var collectionNode = this.$$('[role = doc]').doc[0]['response-data'].Collection[0];
        return collectionNode;
      },

      getColumns:function(){
        return this.$$('[role=doc]').doc[0].interface['item-flat-struct'];
      },

      _onModelChange:function(){
        var actionName = apiSettings.actions[this.modelName].collection;
        this._elements.doc.setActionName(actionName);
      },

      _onQueryChange:function(){
        try{
          this.search  = (!!this.search) ? this.search : '';
          this.sortBy  = (!!this.sortBy) ? this.sortBy.toUpperCase() : '';
          this.refresh();
        }catch(e){console.log('non va')};
      },



      _getCursor         : function(response) {return response.cursor;},
      _getResult         : function(response) {return response.Collection;},
      _getNextPageUrl    : function(cursor)   {return cursor.nxt;},
      _getPrevPageUrl    : function(cursor)   {return cursor.prv},

      _getCurrentPageUrl : function(cursor){
        if(!!cursor && !!cursor.cur) return cursor.cur;
        if(!!this._reqUrl){
          return this._getQueryUrl(this._reqUrl);
        }
        else {
          return null;
        }
      },

      _getQueryUrl:function(url){
        var q='?Q=0';
        if(this.search!== '')q+='&search='+this.search;
        if(this.sortBy!== '')q+='&sort_by='+this.sortBy;
        q+=(this.discend)? '&sort_discend=0':'&sort_discend=1';
        return url+q;
      },

      _getPageIndex:function(cursor){
        var kv = collectionFetcherTools.getJsonFromUrl(cursor.cur);
        return parseInt(kv['page_no']);
      },


      properties: {
        _elements  : Object,
        _reqUrl    : String,

        modelName  : {type:String,  observer:'_onModelChange', notify:true},
        search     : {type:String,  value:'',   observer:'_onQueryChange'},
        sortBy     : {type:String,  value:null, observer:'_onQueryChange'},
        discend    : {type:Boolean, value:true, observer:'_onQueryChange'}
      }
    });
  })();
  </script>
</dom-module>
