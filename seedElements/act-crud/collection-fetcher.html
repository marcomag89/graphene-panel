<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="collection-fetcher">
  <template>
    <graphene-client id="client"></graphene-client>
  </template>
  <script>
    (function() {
      'use strict';

        Polymer({
          is: 'collection-fetcher',

          fetch:function(){
            console.log('fetching');
            document.addEventListener('indexContentScroll', function(e){this._onIndexScroll(e);}.bind(this), false);
            this.start();
            this.loadNextPage();
          },

          start:function(){
            this._launched = true;
            this.clear();
            var paging='';
            if(!!this.pageSize && (this.pageSize % 1 === 0)){
              paging+='/1/'+this.pageSize;
            }
            var settings='';
            if(!!this.sortBy && this.sortBy !==''){
              settings+='sortBy='+this.sortBy;
              if(this.sortMode.toUpperCase() === 'DSC'){settings+='&sortMode='+'DSC';}
              else{settings+='&sortMode='+'ASC';}
            }
            console.log(this.search);
            if(!!this.searchQuery && this.searchQuery !==''){
              if(settings.length > 0){settings+='&';}
              settings+='search='+this.searchQuery;
            }
            if(settings.length >0){settings='?'+settings;}
            this.requestQueuePush(''+paging+encodeURI(settings));
          },

          clear:function(){
            this.reqQueue=[];
            this.result=[];
            this.nxt=null;
            this.prv=null;
            this.cur=null;
          },

          _onIndexScroll:function(e){
            this.lastPosition=e.detail.target.scrollTop;
            if(this.isVisibleInViewport(this.endElement,this.lastPosition)){
              this.requestQueuePush(this.nxt);
              this.loadNextPage();
            }else{
              //console.log('invisible');
            }
          },

          isVisibleInViewport:function(elem,pageYOffset){
            if(elem.offsetParent === null){return false;}
            var panic=window.innerHeight/2;//il panico scatta quando met√† della finestra e stata esplorata
            var y = elem.offsetTop-panic;
            var height = elem.offsetHeight;
            while ( (elem = elem.offsetParent) !== null ){y += elem.offsetTop;} //TODO check this
            var maxHeight = y + height;

            var isVisible = ( y < ( pageYOffset + window.innerHeight ) ) && ( maxHeight >= window.pageYOffset );
            return isVisible;
          },

          requestQueuePush:function(url){
            // console.log(this.reqQueue);
            var alreadyExists=false;
            for(var qValue in this.reqQueue){
              if(this.reqQueue[qValue].url === url){alreadyExists=true;}
            }
            if(!alreadyExists){
              this.reqQueue.push({url:url, pull:false});
            }
          },

          requestQueuePull:function(){
            for(var qValue in this.reqQueue){
              if(!this.reqQueue[qValue].pull){
                this.reqQueue[qValue].pull=true;
                return this.reqQueue[qValue].url;
              }
            }
            return null;
          },

          loadNextPage:function(){
            var client = this.$.client;
            if(!this.busy){
              var pageUrl = this.requestQueuePull();
              if(pageUrl !== null){
                this.busy = true;
                console.log('fetching: '+this.baseUrl+pageUrl);
                client.gFetch(this.baseUrl+pageUrl)
                  .then(function(res){
                    this.result = this.result.concat(res.Collection);
                    if(!!res.cursor.nxt) {this.nxt = res.cursor.nxt.split(this.baseUrl)[1];}
                    this.cur = res.cursor.cur.split(this.baseUrl)[1];
                    if(!!res.cursor.prv) {this.prv = res.cursor.prv.split(this.baseUrl)[1];}
                    this.busy = false;
                  }.bind(this))
                  .catch(function (err) {
                    this.busy = false;
                    console.error(err);
                  }.bind(this));
              }
            }
          },

          _settingsChanged:function(){
            if(this.auto && this._launched){
              this.start();
              this.loadNextPage();
            }
          },

          properties: {
            action       : String,
            baseUrl      : {type:String,  value:'',    observer:'_settingsChanged' },
            sortBy       : {type:String,  value:'',    observer:'_settingsChanged'},
            sortMode     : {type:String,  value:'',    observer:'_settingsChanged'},
            pageSize     : {type:Number,  value:'',    observer:'_settingsChanged'},
            searchQuery  : {type:String,  value:'',    observer:'_settingsChanged'},
            auto         : {type:Boolean, value:false, observer:'_settingsChanged'},

            result       : {type:Array,   value:[],   notify:true },

            //Fetching monitor
            _launched    : {type:Boolean, value:false},
            reqQueue     : {type:Array,   value:[], notify:true},
            busy         : {type:Boolean, value:false},
            endElement   : Object,

            //Cursor information
            nxt          : {type:String, value:null, notify:true},
            prv          : {type:String, value:null, notify:true},
            cur          : {type:String, value:null, notify:true},
            pageLoaded   : {},
            lastPosition : Number,
            panic        : {type:Number,value:600}
          }
        });
    })();
  </script>
</dom-module>
